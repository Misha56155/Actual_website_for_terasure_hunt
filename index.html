<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Treasure Hunt – Code Check</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 40px; }
    label, input, button { font-size: 18px; }
    #status { margin-top: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-height: 24px; }
    .ok { background: #e7f6ec; border-color: #b7e1c1; }
    .err { background: #fde8e8; border-color: #f5b5b5; }
    .warn { background: #fff4e5; border-color: #ffd7a8; }
  </style>
</head>
<body>
  <h1>Enter your code</h1>

  <form id="f" novalidate>
    <label for="code">Code</label><br>
    <input id="code" name="code" type="text" inputmode="numeric" maxlength="7" autocomplete="one-time-code" placeholder="digits only" />
    <button id="go" type="submit">Check</button>
  </form>

  <div id="status" aria-live="polite"></div>

  <script>
    const API_URL = '/api/check';


    const f = document.getElementById('f');
    const codeInput = document.getElementById('code');
    const statusBox = document.getElementById('status');
    const goBtn = document.getElementById('go');

    // Keep only digits, cap at 7
    codeInput.addEventListener('input', () => {
      codeInput.value = codeInput.value.replace(/\D/g, '').slice(0, 7);
    });

    f.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearStatus();

      const code = (codeInput.value || '').trim();
      if (!/^\d{6,7}$/.test(code)) {
        show('Invalid code format.', 'err');
        codeInput.focus();
        return;
      }

      setLoading(true);
      show('Checking…', 'warn');

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });

        if (res.status === 429) {
          show('Too many attempts — wait a minute and try again.', 'warn');
          return;
        }
        if (!res.ok) {
          const t = await res.text();
          show('Server error. Try again.', 'err');
          console.debug('Non-OK:', res.status, t);
          return;
        }

        // Try to parse JSON; if not JSON, show raw text for debugging
        let data;
        try {
          data = await res.clone().json();
        } catch {
          const t = await res.text();
          show(t || 'Unexpected response from server.', 'err');
          console.debug('Non-JSON body:', t);
          return;
        }

        if (data && data.ok) {
          show(data.message || 'Success!', 'ok');
          codeInput.value = '';
        } else if (data && data.reason === 'bad_format') {
          show('Invalid code format.', 'err');
        } else {
          show('Nope, wrong code. Try again!', 'err');
        }
      } catch (err) {
        show('Network error — check your connection.', 'err');
        console.error(err);
      } finally {
        setLoading(false);
      }
    });

    function show(msg, cls) {
      statusBox.className = '';
      if (cls) statusBox.classList.add(cls);
      statusBox.textContent = msg;
    }
    function clearStatus() { statusBox.className = ''; statusBox.textContent = ''; }
    function setLoading(on) { goBtn.disabled = on; codeInput.readOnly = on; }

    // focus on load
    window.addEventListener('DOMContentLoaded', () => codeInput.focus());
  </script>
</body>
</html>
